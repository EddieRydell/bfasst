# This script adds the clock signals back in to the blif file generated by ABC

# This script works by reading the blif file generated by yosys to try to figure
#   out what the clock signal name is. It then modifies the blif file made by
#   ABC to re-add this signal.

import sys
import fileinput


def main():
    if len(sys.argv) != 3:
        print("Usage: add_blif_clock.py yosys_out.blif abc_out.blif")

    # First find the clock signal in the yosys file
    clk = None
    with open(sys.argv[1]) as yos:
        for line in yos:
            if len(line.split()) == 0:
                continue
            if line.split()[0] == ".latch":
                clk = line.split()[4]
                print("Identified clock signal", clk)
                break

    # Now add clock signals to the abc file
    with fileinput.input(files=sys.argv[2], inplace=True) as abc:
        for line in abc:
            line = line.strip()
            if len(line.split()) == 0:
                print(line)
                continue
            if line.split()[0] == ".latch":
                line_arr = line.split()
                line_arr.insert(3, "re")
                line_arr.insert(4, clk)
                new_line = " ".join(line_arr)
                print(new_line)
                continue
            else:
                print(line)


if __name__ == "__main__":
    main()
